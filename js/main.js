
// ---- FALLBACK DATA (used if fetch of data/tokens.json fails on file://) ----
window.FALLBACK_TOKENS = [
  {
    "id": "mask",
    "name": "MASK",
    "symbol": "MASK",
    "icon": "assets/default-token.svg",
    "mcap_usd": 9410000,
    "change_pct": -4.23
  },
  {
    "id": "aida",
    "name": "AIDA",
    "symbol": "AIDA",
    "icon": "assets/default-token.svg",
    "mcap_usd": 8130000,
    "change_pct": -0.4
  },
  {
    "id": "dollo",
    "name": "dollo",
    "symbol": "DOLLO",
    "icon": "assets/default-token.svg",
    "mcap_usd": 6610000,
    "change_pct": -4.5
  },
  {
    "id": "assdaq",
    "name": "ASSDAQ",
    "symbol": "ASSDAQ",
    "icon": "assets/default-token.svg",
    "mcap_usd": 5470000,
    "change_pct": 5.94
  },
  {
    "id": "sc",
    "name": "SC",
    "symbol": "SC",
    "icon": "assets/default-token.svg",
    "mcap_usd": 5280000,
    "change_pct": -4.73
  },
  {
    "id": "dolan",
    "name": "DOLAN",
    "symbol": "DOLAN",
    "icon": "assets/default-token.svg",
    "mcap_usd": 5220000,
    "change_pct": 1.13
  },
  {
    "id": "grift",
    "name": "GRIFT",
    "symbol": "GRIFT",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4940000,
    "change_pct": 0.14
  },
  {
    "id": "skbdi",
    "name": "SKBDI",
    "symbol": "SKBDI",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4920000,
    "change_pct": 17.0
  },
  {
    "id": "awr",
    "name": "AWR",
    "symbol": "AWR",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4630000,
    "change_pct": -4.25
  },
  {
    "id": "trencher",
    "name": "TRENCHER",
    "symbol": "TRENCHER",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4430000,
    "change_pct": -5.52
  },
  {
    "id": "billy",
    "name": "BILLY",
    "symbol": "BILLY",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4240000,
    "change_pct": 5.2
  },
  {
    "id": "momo",
    "name": "MOMO",
    "symbol": "MOMO",
    "icon": "assets/default-token.svg",
    "mcap_usd": 4051000,
    "change_pct": -20.0
  },
  {
    "id": "ssx",
    "name": "SSX",
    "symbol": "SSX",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3630000,
    "change_pct": -17.0
  },
  {
    "id": "rasmr",
    "name": "rasmr",
    "symbol": "RASMR",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3970000,
    "change_pct": -3.5
  },
  {
    "id": "dollar1",
    "name": "$1",
    "symbol": "$1",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3950000,
    "change_pct": -1.76
  },
  {
    "id": "memecoin",
    "name": "memecoin",
    "symbol": "MEME",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3930000,
    "change_pct": -17.0
  },
  {
    "id": "wizard",
    "name": "Wizard",
    "symbol": "WIZ",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3860000,
    "change_pct": 32.6
  },
  {
    "id": "cupsey",
    "name": "Cupsey",
    "symbol": "CUP",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3680000,
    "change_pct": -7.04
  },
  {
    "id": "gnzystm",
    "name": "gnzystm",
    "symbol": "GNZ",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3270000,
    "change_pct": 0.72
  },
  {
    "id": "lc",
    "name": "LC",
    "symbol": "LC",
    "icon": "assets/default-token.svg",
    "mcap_usd": 3250000,
    "change_pct": 3.19
  },
  {
    "id": "italianrot",
    "name": "Italianrot",
    "symbol": "ITA",
    "icon": "assets/default-token.svg",
    "mcap_usd": 2740000,
    "change_pct": -9.15
  },
  {
    "id": "basedd",
    "name": "BASEDD",
    "symbol": "BASEDD",
    "icon": "assets/default-token.svg",
    "mcap_usd": 2310000,
    "change_pct": -6.85
  },
  {
    "id": "ikun",
    "name": "IKUN",
    "symbol": "IKUN",
    "icon": "assets/default-token.svg",
    "mcap_usd": 2170000,
    "change_pct": -4.15
  },
  {
    "id": "mooncat",
    "name": "MOONCAT",
    "symbol": "MOONCAT",
    "icon": "assets/default-token.svg",
    "mcap_usd": 2151000,
    "change_pct": -7.08
  },
  {
    "id": "tbc",
    "name": "TBC",
    "symbol": "TBC",
    "icon": "assets/default-token.svg",
    "mcap_usd": 2850000,
    "change_pct": -2.7
  },
  {
    "id": "rys",
    "name": "RYS",
    "symbol": "RYS",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1710000,
    "change_pct": 18.0
  },
  {
    "id": "diddybop",
    "name": "DIDDYBOP",
    "symbol": "DIDDY",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1430000,
    "change_pct": 32.0
  },
  {
    "id": "valentine",
    "name": "Valentine",
    "symbol": "VAL",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1600000,
    "change_pct": -5.21
  },
  {
    "id": "bluechip",
    "name": "BlueChip",
    "symbol": "BLUE",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1290000,
    "change_pct": -16.0
  },
  {
    "id": "wojakify",
    "name": "wojakify",
    "symbol": "WOJ",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1250000,
    "change_pct": 32267.0
  },
  {
    "id": "dna",
    "name": "DNA",
    "symbol": "DNA",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1120000,
    "change_pct": 44.0
  },
  {
    "id": "buttplug",
    "name": "BUTTPLUG",
    "symbol": "BTT",
    "icon": "assets/default-token.svg",
    "mcap_usd": 1340000,
    "change_pct": 26.0
  }
];

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function compactUSD(n) {
  if (n >= 1e9) return "$" + (n/1e9).toFixed(2) + "B";
  if (n >= 1e6) return "$" + (n/1e6).toFixed(2) + "M";
  if (n >= 1e3) return "$" + (n/1e3).toFixed(2) + "K";
  return "$" + n.toFixed(2);
}

function pctColorClass(p) { return p >= 0 ? "gain" : "loss"; }
function signedPct(p) { const sign = p > 0 ? "+" : ""; return sign + p.toFixed(2) + "%"; }

async function loadTokens() {
  try {
    const res = await fetch("data/tokens.json");
    if (!res.ok) throw new Error("not ok");
    return await res.json();
  } catch (e) {
    console.warn("Using FALLBACK_TOKENS (likely file://)", e);
    return window.FALLBACK_TOKENS;
  }
}

// simple DJB2 hash -> lane
function hashToLane(str, lanes) {
  let h = 5381;
  for (let i=0;i<str.length;i++) h = ((h<<5) + h) + str.charCodeAt(i);
  return Math.abs(h) % lanes;
}

document.addEventListener("DOMContentLoaded", async () => {
  const tokens = await loadTokens();
  const page = document.body.dataset.page;
  if (page === "board") initBoard(tokens);
  if (page === "race") initRace(tokens);
});

// -------------------- BOARD --------------------
function initBoard(tokens) {
  const sortSel = $("#sortSelect");
  const filtSel = $("#filterSelect");
  const board = $("#board");

  const state = { sortKey: sortSel.value, filter: filtSel.value };

  function applyState() {
    let list = tokens.slice();
    if (state.filter === "gainers") list = list.filter(t => t.change_pct > 0);
    if (state.filter === "losers") list = list.filter(t => t.change_pct < 0);

    if (state.sortKey === "mcap_desc") list.sort((a,b)=>b.mcap_usd - a.mcap_usd);
    if (state.sortKey === "change_desc") list.sort((a,b)=>b.change_pct - a.change_pct);
    if (state.sortKey === "name_asc") list.sort((a,b)=>a.name.localeCompare(b.name));

    render(list);
  }

  function render(list) {
    board.innerHTML = "";
    if (!list.length) {
      const empty = document.createElement("div");
      empty.textContent = "No tokens match your filter.";
      empty.style.opacity = .7;
      board.appendChild(empty);
      return;
    }
    for (const t of list) {
      const a = document.createElement("a");
      a.href = "#";
      a.className = "card " + pctColorClass(t.change_pct);
      a.setAttribute("aria-label", `${t.name} ${compactUSD(t.mcap_usd)}, change ${signedPct(t.change_pct)}`);
      a.innerHTML = `
        <div class="row">
          <img src="${t.icon}" alt=""/>
          <div class="name">${t.name}</div>
        </div>
        <div class="meta">
          <div class="mcap">${compactUSD(t.mcap_usd)}</div>
          <div class="pct ${pctColorClass(t.change_pct)}">${signedPct(t.change_pct)}</div>
        </div>`;
      board.appendChild(a);
    }
  }

  sortSel.addEventListener("change", e => { state.sortKey = sortSel.value; applyState(); });
  filtSel.addEventListener("change", e => { state.filter = filtSel.value; applyState(); });
  applyState();
}

// -------------------- RACE --------------------
function initRace(tokens) {
  const buttons = $$(".rail-btn");
  const bubbles = $("#bubbles");
  const lbTop3 = $("#lb-top3");
  const lbList = $("#lb-list");

  const state = { target: 1e7 };

  function setTarget(t) {
    state.target = t;
    buttons.forEach(btn => {
      const active = Number(btn.dataset.target) === t;
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
    });
    render();
  }

  buttons.forEach(btn => btn.addEventListener("click", () => setTarget(Number(btn.dataset.target))));
  setTarget(state.target);

  function lanesForWidth() {
    const w = bubbles.clientWidth || 800;
    if (w < 420) return 6;
    if (w < 720) return 8;
    if (w < 1100) return 10;
    return 12;
  }

  function renderBubbles(list) {
    bubbles.innerHTML = "";
    const lanes = lanesForWidth();
    const minSize = 36, maxSize = 72;

    // tooltip element (re-used)
    const tip = document.createElement("div");
    tip.className = "tooltip";
    tip.setAttribute("role", "tooltip");
    tip.style.display = "none";
    bubbles.appendChild(tip);

    function showTip(x,y,html) {
      tip.innerHTML = html;
      tip.style.left = x + "px";
      tip.style.top = y + "px";
      tip.style.display = "block";
    }
    function hideTip() { tip.style.display = "none"; }

    list.forEach(t => {
      const ratio = Math.max(0, Math.min(1, t.mcap_usd / state.target));
      const y = ratio * 100;
      const lane = hashToLane(t.name, lanes);
      const x = ((lane + 0.5) / lanes) * 100;
      const s = minSize + (Math.sqrt(t.mcap_usd) / Math.sqrt(state.target)) * (maxSize - minSize);

      const b = document.createElement("button");
      b.className = "bubble " + pctColorClass(t.change_pct) + (t.mcap_usd >= state.target ? " reached" : "");
      b.style.left = x + "%";
      b.style.bottom = y + "%";
      b.style.width = s + "px";
      b.style.height = s + "px";
      b.setAttribute("aria-label", `${t.name} at ${compactUSD(t.mcap_usd)}; change ${signedPct(t.change_pct)}`);
      b.innerHTML = `<img alt="" src="${t.icon}"/><div class="tag"><span class="name">${t.name}</span> <span class="pct ${pctColorClass(t.change_pct)}">${signedPct(t.change_pct)}</span></div>`;

      b.addEventListener("mouseenter", e => showTip(e.clientX, e.clientY, `<strong>${t.name}</strong><div class="muted">${compactUSD(t.mcap_usd)} · ${signedPct(t.change_pct)}</div>`));
      b.addEventListener("mouseleave", hideTip);
      b.addEventListener("focus", e => {
        const rect = b.getBoundingClientRect();
        showTip(rect.left + rect.width/2, rect.top, `<strong>${t.name}</strong><div class="muted">${compactUSD(t.mcap_usd)} · ${signedPct(t.change_pct)}</div>`);
      });
      b.addEventListener("blur", hideTip);

      bubbles.appendChild(b);
    });
  }

  function renderLeaderboard(list) {
    const sorted = list.slice().sort((a,b)=>b.mcap_usd - a.mcap_usd);
    const top3 = sorted.slice(0,3);
    lbTop3.innerHTML = "";
    const medals = ["gold","silver","bronze"];
    top3.forEach((t, i) => {
      const d = document.createElement("div");
      d.className = "medal " + medals[i];
      d.innerHTML = `<div class="name">${t.name}</div><div class="mcap">${compactUSD(t.mcap_usd)}</div>`;
      lbTop3.appendChild(d);
    });

    lbList.innerHTML = "";
    sorted.slice(3).forEach((t, idx) => {
      const li = document.createElement("li");
      li.className = "lb-item";
      li.innerHTML = `<div class="left"><span class="pos">${idx+4}.</span> <span class="name">${t.name}</span></div>
                      <div class="right"><span class="mcap">${compactUSD(t.mcap_usd)}</span> · <span class="pct ${pctColorClass(t.change_pct)}">${signedPct(t.change_pct)}</span></div>`;
      lbList.appendChild(li);
    });
  }

  function render() {
    const sorted = tokens.slice().sort((a,b)=>b.mcap_usd - a.mcap_usd);
    renderBubbles(sorted);
    renderLeaderboard(sorted);
  }
}

